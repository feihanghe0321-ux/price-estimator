<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>任务预期报价计算器（场景区分）</title>
<style>
  body { font-family: Arial; background:#f7f8fa; padding:24px; }
  .container { max-width:1100px; margin:auto; background:#fff; padding:24px; border-radius:8px; }
  table { width:100%; border-collapse:collapse; margin-bottom:16px; }
  th, td { border:1px solid #e5e6eb; padding:8px; text-align:center; }
  th { background:#f2f3f5; }
  th.scene-header { background:#fff1f0; color:#cf1322; font-weight:bold; }
  input, select { width:90%; padding:6px; }
  button { padding:6px 12px; border:none; border-radius:4px; cursor:pointer; }
  button.add { background:#1677ff; color:#fff; margin-bottom:12px; }
  button.delete { background:#ff4d4f; color:#fff; }
  .result { margin-top:16px; background:#f6ffed; padding:12px; border-radius:6px; }
  .scene-title { margin-top:12px; font-weight:bold; color:#1890ff; }
</style>
</head>
<body>
<div class="container">
  <h2>任务预期报价计算器（按场景区分）</h2>

  <table>
    <thead>
      <tr>
        <th class="scene-header">场景<span style="color:#cf1322;">*</span></th>
        <th>作业条数</th>
        <th>音频时长</th>
        <th>时长单位</th>
        <th>报价</th>
        <th>报价单位</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <button class="add" onclick="addRow()">新增历史记录</button>

  <h3 style="margin-top:20px;">当前任务</h3>
  当前任务音频时长（秒）：<input type="number" id="currentSeconds" />
  <br/><br/>
  当前任务场景：
  <select id="currentScene">
    <option value="标注">标注</option>
    <option value="质检">质检</option>
  </select>
  <br/><br/>
  <button class="add" onclick="calculate()">计算预期报价</button>

  <div class="result" id="result" style="display:none;"></div>
</div>

<script>
const KEY = 'price_model_v4';
const tbody = document.getElementById('tbody');

function addRow(d={}) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>
      <select>
        <option value="标注" ${d.scene==='标注'?'selected':''}>标注</option>
        <option value="质检" ${d.scene==='质检'?'selected':''}>质检</option>
      </select>
    </td>
    <td><input type="number" value="${d.count||''}"></td>
    <td><input type="number" value="${d.duration||''}"></td>
    <td>
      <select>
        <option value="hour" ${d.timeUnit==='hour'?'selected':''}>小时</option>
        <option value="second" ${d.timeUnit==='second'?'selected':''}>秒</option>
      </select>
    </td>
    <td><input type="number" value="${d.price||''}"></td>
    <td>
      <select>
        <option value="per_item" ${d.priceUnit==='per_item'?'selected':''}>元/条</option>
        <option value="per_second" ${d.priceUnit==='per_second'?'selected':''}>元/秒</option>
      </select>
    </td>
    <td><button class="delete" onclick="removeRow(this)">删除</button></td>
  `;
  tbody.appendChild(tr);
}

function removeRow(btn) {
  btn.closest('tr').remove();
  save();
}

function save() {
  const data = [];
  tbody.querySelectorAll('tr').forEach(tr=>{
    data.push({
      scene: tr.children[0].querySelector('select').value,
      count: tr.children[1].querySelector('input').value,
      duration: tr.children[2].querySelector('input').value,
      timeUnit: tr.children[3].querySelector('select').value,
      price: tr.children[4].querySelector('input').value,
      priceUnit: tr.children[5].querySelector('select').value
    });
  });
  localStorage.setItem(KEY, JSON.stringify(data));
}

function load() {
  const data = JSON.parse(localStorage.getItem(KEY) || '[]');
  data.length ? data.forEach(d=>addRow(d)) : addRow();
}

function calculate() {
  save();
  const sceneMap = {};
  tbody.querySelectorAll('tr').forEach(tr=>{
    const scene = tr.children[0].querySelector('select').value || '标注';
    const count = parseFloat(tr.children[1].querySelector('input').value) || 0;
    let duration = parseFloat(tr.children[2].querySelector('input').value) || 0;
    const timeUnit = tr.children[3].querySelector('select').value;
    const price = parseFloat(tr.children[4].querySelector('input').value) || 0;
    const priceUnit = tr.children[5].querySelector('select').value;

    const seconds = timeUnit==='hour'?duration*3600:duration;
    const rowTotalPrice = priceUnit==='per_item'?count*price:price*seconds;

    if (!sceneMap[scene]) sceneMap[scene]={totalSeconds:0,totalPrice:0};
    sceneMap[scene].totalSeconds += seconds;
    sceneMap[scene].totalPrice += rowTotalPrice;
  });

  const currentSeconds = parseFloat(document.getElementById('currentSeconds').value);
  const currentScene = document.getElementById('currentScene').value;
  if (!currentSeconds || !sceneMap[currentScene]) return alert('请补全数据');

  const unitPrice = sceneMap[currentScene].totalPrice / sceneMap[currentScene].totalSeconds;
  const expected = unitPrice * currentSeconds;

  let html = '';
  for (const s in sceneMap){
    const u = sceneMap[s].totalPrice / sceneMap[s].totalSeconds;
    html += `<div class="scene-title">${s}场景：</div>`;
    html += `综合历史单价：${u.toFixed(6)} 元 / 秒<br/>`;
    if (s===currentScene){
      html += `当前任务预期报价：<strong>${expected.toFixed(2)} 元</strong><br/>`;
    }
  }

  const resultDiv = document.getElementById('result');
  resultDiv.style.display='block';
  resultDiv.innerHTML = html;
}

document.addEventListener('input', save);
load();
</script>
</body>
</html>
